// Compiled on 6/23/2011 using the Closure Compiler, with simple optimization.
// http://closure-compiler.appspot.com/

// Changed RSA SHA1 & SHA256 hex functions to use different library


//
// rsa-sign.js - adding signing functions to RSAKey class.
//
//
// version: 1.0 (2010-Jun-03)
//
// Copyright (c) 2010 Kenji Urushima (kenji.urushima@gmail.com)
//
// This software is licensed under the terms of the MIT License.
// http://www.opensource.org/licenses/mit-license.php
//
// The above copyright and license notice shall be 
// included in all copies or substantial portions of the Software.

//
// Depends on:
//   function sha1.hex(s) of sha1.js
//   jsbn.js
//   jsbn2.js
//   rsa.js
//   rsa2.js
//

// As for _RSASGIN_DIHEAD values for each hash algorithm, see PKCS#1 v2.1 spec (p38).
var _RSASIGN_DIHEAD = [];
_RSASIGN_DIHEAD['sha1'] = "3021300906052b0e03021a05000414";
_RSASIGN_DIHEAD['sha256'] = "3031300d060960864801650304020105000420";
//_RSASIGN_DIHEAD['md2'] = "3020300c06082a864886f70d020205000410";
//_RSASIGN_DIHEAD['md5'] = "3020300c06082a864886f70d020505000410";
//_RSASIGN_DIHEAD['sha384'] = "3041300d060960864801650304020205000430";
//_RSASIGN_DIHEAD['sha512'] = "3051300d060960864801650304020305000440";
var _RSASIGN_HASHHEXFUNC = [];
//_RSASIGN_HASHHEXFUNC['sha1'] = sha1.hex;
//_RSASIGN_HASHHEXFUNC['sha256'] = sha256.hex;

//edited
_RSASIGN_HASHHEXFUNC['sha1'] = hex_sha1;

// ========================================================================
// Signature Generation
// ========================================================================

function _rsasign_getHexPaddedDigestInfoForString(a,c,b){c/=4;for(var a=(0,_RSASIGN_HASHHEXFUNC[b])(a),b="00"+_RSASIGN_DIHEAD[b]+a,a="",c=c-4-b.length,d=0;d<c;d+=2)a+="ff";return sPaddedMessageHex="0001"+a+b}function _rsasign_signString(a,c){var b=_rsasign_getHexPaddedDigestInfoForString(a,this.n.bitLength(),c);return this.doPrivate(parseBigInt(b,16)).toString(16)}
function _rsasign_signStringWithSHA1(a){a=_rsasign_getHexPaddedDigestInfoForString(a,this.n.bitLength(),"sha1");return this.doPrivate(parseBigInt(a,16)).toString(16)}function _rsasign_signStringWithSHA256(a){a=_rsasign_getHexPaddedDigestInfoForString(a,this.n.bitLength(),"sha256");return this.doPrivate(parseBigInt(a,16)).toString(16)};

// ========================================================================
// Signature Verification
// ========================================================================

function _rsasign_getDecryptSignatureBI(c,a,b){var d=new RSAKey;d.setPublic(a,b);return d.doPublic(c)}function _rsasign_getHexDigestInfoFromSig(c,a,b){return _rsasign_getDecryptSignatureBI(c,a,b).toString(16).replace(/^1f+00/,"")}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(c){for(var a in _RSASIGN_DIHEAD){var b=_RSASIGN_DIHEAD[a],d=b.length;if(c.substring(0,d)==b)return[a,c.substring(d)]}return[]}
function _rsasign_verifySignatureWithArgs(c,a,b,d){a=_rsasign_getHexDigestInfoFromSig(a,b,d);b=_rsasign_getAlgNameAndHashFromHexDisgestInfo(a);if(b.length==0)return!1;a=b[1];c=(0,_RSASIGN_HASHHEXFUNC[b[0]])(c);return a==c}function _rsasign_verifyHexSignatureForMessage(c,a){var b=parseBigInt(c,16);return _rsasign_verifySignatureWithArgs(a,b,this.n.toString(16),this.e.toString(16))}
function _rsasign_verifyString(c,a){var a=a.replace(/[ \n]+/g,""),b=this.doPublic(parseBigInt(a,16)).toString(16).replace(/^1f+00/,""),d=_rsasign_getAlgNameAndHashFromHexDisgestInfo(b);if(d.length==0)return!1;b=d[1];d=(0,_RSASIGN_HASHHEXFUNC[d[0]])(c);return b==d}RSAKey.prototype.signString=_rsasign_signString;RSAKey.prototype.signStringWithSHA1=_rsasign_signStringWithSHA1;RSAKey.prototype.signStringWithSHA256=_rsasign_signStringWithSHA256;RSAKey.prototype.verifyString=_rsasign_verifyString;
RSAKey.prototype.verifyHexSignatureForMessage=_rsasign_verifyHexSignatureForMessage;


//begin x509.js
function _x509_pemToBase64(a){a=a.replace("-----BEGIN CERTIFICATE-----","");a=a.replace("-----END CERTIFICATE-----","");return a=a.replace(/[ \n]+/g,"")}function _x509_pemToHex(a){a=_x509_pemToBase64(a);return b64tohex(a)}function _x509_getHexTbsCertificateFromCert(a){return _asnhex_getStartPosOfV_AtObj(a,0)} function _x509_getSubjectPublicKeyInfoPosFromCertHex(a){var b=_asnhex_getStartPosOfV_AtObj(a,0),b=_asnhex_getPosArrayOfChildren_AtObj(a,b);if(b.length<1)return-1;if(a.substring(b[0],b[0]+10)=="a003020102"){if(b.length<6)return-1;return b[6]}else{if(b.length<5)return-1;return b[5]}} function _x509_getSubjectPublicKeyPosFromCertHex(a){var b=_x509_getSubjectPublicKeyInfoPosFromCertHex(a);if(b==-1)return-1;b=_asnhex_getPosArrayOfChildren_AtObj(a,b);if(b.length!=2)return-1;b=b[1];if(a.substring(b,b+2)!="03")return-1;b=_asnhex_getStartPosOfV_AtObj(a,b);if(a.substring(b,b+2)!="00")return-1;return b+2} function _x509_getPublicKeyHexArrayFromCertHex(a){var b=_x509_getSubjectPublicKeyPosFromCertHex(a),c=_asnhex_getPosArrayOfChildren_AtObj(a,b);if(c.length!=2)return[];b=_asnhex_getHexOfV_AtObj(a,c[0]);a=_asnhex_getHexOfV_AtObj(a,c[1]);return b!=null&&a!=null?[b,a]:[]}function _x509_getPublicKeyHexArrayFromCertPEM(a){a=_x509_pemToHex(a);return _x509_getPublicKeyHexArrayFromCertHex(a)} function _x509_readCertPEM(a){var a=_x509_pemToHex(a),a=_x509_getPublicKeyHexArrayFromCertHex(a),b=new RSAKey;b.setPublic(a[0],a[1]);this.subjectPublicKeyRSA=b;this.subjectPublicKeyRSA_hN=a[0];this.subjectPublicKeyRSA_hE=a[1]}function _x509_readCertPEMWithoutRSAInit(a){a=_x509_pemToHex(a);a=_x509_getPublicKeyHexArrayFromCertHex(a);this.subjectPublicKeyRSA.setPublic(a[0],a[1]);this.subjectPublicKeyRSA_hN=a[0];this.subjectPublicKeyRSA_hE=a[1]} function X509(){this.subjectPublicKeyRSA_hE=this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null}X509.prototype.readCertPEM=_x509_readCertPEM;X509.prototype.readCertPEMWithoutRSAInit=_x509_readCertPEMWithoutRSAInit;


// begin rsa-pem.js
function _rsapem_pemToBase64(a){a=a.replace("-----BEGIN RSA PRIVATE KEY-----","");a=a.replace("-----END RSA PRIVATE KEY-----","");return a=a.replace(/[ \n]+/g,"")} function _rsapem_getPosArrayOfChildrenFromHex(a){var b=[],c=_asnhex_getStartPosOfV_AtObj(a,0),d=_asnhex_getPosOfNextSibling_AtObj(a,c),e=_asnhex_getPosOfNextSibling_AtObj(a,d),f=_asnhex_getPosOfNextSibling_AtObj(a,e),g=_asnhex_getPosOfNextSibling_AtObj(a,f),h=_asnhex_getPosOfNextSibling_AtObj(a,g),i=_asnhex_getPosOfNextSibling_AtObj(a,h),j=_asnhex_getPosOfNextSibling_AtObj(a,i),a=_asnhex_getPosOfNextSibling_AtObj(a,j);b.push(c,d,e,f,g,h,i,j,a);return b} function _rsapem_getHexValueArrayOfChildrenFromHex(a){var b=_rsapem_getPosArrayOfChildrenFromHex(a),c=_asnhex_getHexOfV_AtObj(a,b[0]),d=_asnhex_getHexOfV_AtObj(a,b[1]),e=_asnhex_getHexOfV_AtObj(a,b[2]),f=_asnhex_getHexOfV_AtObj(a,b[3]),g=_asnhex_getHexOfV_AtObj(a,b[4]),h=_asnhex_getHexOfV_AtObj(a,b[5]),i=_asnhex_getHexOfV_AtObj(a,b[6]),j=_asnhex_getHexOfV_AtObj(a,b[7]),a=_asnhex_getHexOfV_AtObj(a,b[8]),b=[];b.push(c,d,e,f,g,h,i,j,a);return b} function _rsapem_readPrivateKeyFromPEMString(a){a=_rsapem_pemToBase64(a);a=b64tohex(a);a=_rsapem_getHexValueArrayOfChildrenFromHex(a);this.setPrivateEx(a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}RSAKey.prototype.readPrivateKeyFromPEMString=_rsapem_readPrivateKeyFromPEMString;

//begin asn1hex.js
function _asnhex_getByteLengthOfL_AtObj(c,b){if(c.substring(b+2,b+3)!="8")return 1;var a=parseInt(c.substring(b+3,b+4));if(a==0)return-1;if(0<a&&a<10)return a+1;return-2}function _asnhex_getHexOfL_AtObj(c,b){var a=_asnhex_getByteLengthOfL_AtObj(c,b);if(a<1)return"";return c.substring(b+2,b+2+a*2)}function _asnhex_getIntOfL_AtObj(c,b){var a=_asnhex_getHexOfL_AtObj(c,b);if(a=="")return-1;return(parseInt(a.substring(0,1))<8?parseBigInt(a,16):parseBigInt(a.substring(2),16)).intValue()} function _asnhex_getStartPosOfV_AtObj(c,b){var a=_asnhex_getByteLengthOfL_AtObj(c,b);if(a<0)return a;return b+(a+1)*2}function _asnhex_getHexOfV_AtObj(c,b){var a=_asnhex_getStartPosOfV_AtObj(c,b),d=_asnhex_getIntOfL_AtObj(c,b);return c.substring(a,a+d*2)}function _asnhex_getPosOfNextSibling_AtObj(c,b){var a=_asnhex_getStartPosOfV_AtObj(c,b),d=_asnhex_getIntOfL_AtObj(c,b);return a+d*2} function _asnhex_getPosArrayOfChildren_AtObj(c,b){var a=[],d=_asnhex_getStartPosOfV_AtObj(c,b);a.push(d);for(var g=_asnhex_getIntOfL_AtObj(c,b),e=d,f=0;;){e=_asnhex_getPosOfNextSibling_AtObj(c,e);if(e==null||e-d>=g*2)break;if(f>=200)break;a.push(e);f++}return a};