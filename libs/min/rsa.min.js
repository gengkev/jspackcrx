/* Modified by Kevin Geng, 2011-12
 * This file consists of rsa.mod.js and rsa2.mod.js
 * Compiled using Closure Compiler (Simple) on 02/04/2011 http://closure-compiler.appspot.com/home
 *
 * Released under the GPLv3; see /trunk/LICENSE for details.
 * See the unminified files in ../mod for details on changes to the original.
 */

// Depends on jsbn.js and rng.js

// Version 1.1: support utf-8 encoding in pkcs1pad2

function pkcs1pad2(a,b){if(b<a.length+11)throw Error("Message too long for RSA");for(var d=[],e=a.length-1;0<=e&&0<b;){var c=a.charCodeAt(e--);128>c?d[--b]=c:127<c&&2048>c?(d[--b]=c&63|128,d[--b]=c>>6|192):(d[--b]=c&63|128,d[--b]=c>>6&63|128,d[--b]=c>>12|224)}d[--b]=0;e=new SecureRandom;for(c=[];2<b;){for(c[0]=0;0==c[0];)e.nextBytes(c);d[--b]=c[0]}d[--b]=2;d[--b]=0;return new BigInteger(d)}function RSAKey(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}
RSAKey.prototype.setPublic=function(a,b){if(null!=a&&null!=b&&0<a.length&&0<b.length)this.n=new BigInteger(a,16),this.e=parseInt(b,16);else throw Error("Invalid RSA public key");};RSAKey.prototype.doPublic=function(a){return a.modPowInt(this.e,this.n)};RSAKey.prototype.encrypt=function(a){a=pkcs1pad2(a,this.n.bitLength()+7>>3);if(null==a)return null;a=this.doPublic(a);if(null==a)return null;a=a.toString(16);return 0==(a.length&1)?a:"0"+a};

// Depends on rsa.js and jsbn2.js

// Version 1.1: support utf-8 decoding in pkcs1unpad2

function pkcs1unpad2(a,d){for(var c=a.toByteArray(),b=0;b<c.length&&0==c[b];)++b;if(c.length-b!=d-1||2!=c[b])return null;for(++b;0!=c[b];)if(++b>=c.length)return null;for(var e="";++b<c.length;){var f=c[b]&255;128>f?e+=String.fromCharCode(f):191<f&&224>f?(e+=String.fromCharCode((f&31)<<6|c[b+1]&63),++b):(e+=String.fromCharCode((f&15)<<12|(c[b+1]&63)<<6|c[b+2]&63),b+=2)}return e}
RSAKey.prototype.setPrivate=function(a,d,c){if(null!=a&&null!=d&&0<a.length&&0<d.length)this.n=new BigInteger(a,16),this.e=parseInt(d,16),this.d=new BigInteger(c,16);else throw Error("Invalid RSA private key");};
RSAKey.prototype.setPrivateEx=function(a,d,c,b,e,f,g,h){if(null!=a&&null!=d&&0<a.length&&0<d.length)this.n=new BigInteger(a,16),this.e=parseInt(d,16),this.d=new BigInteger(c,16),this.p=new BigInteger(b,16),this.q=new BigInteger(e,16),this.dmp1=new BigInteger(f,16),this.dmq1=new BigInteger(g,16),this.coeff=new BigInteger(h,16);else throw Error("Invalid RSA private key");};
RSAKey.prototype.generate=function(a,d){var c=new SecureRandom,b=a>>1;this.e=parseInt(d,16);for(var e=new BigInteger(d,16);;){for(;!(this.p=new BigInteger(a-b,1,c),0==this.p.subtract(BigInteger.ONE).gcd(e).compareTo(BigInteger.ONE)&&this.p.isProbablePrime(10)););for(;!(this.q=new BigInteger(b,1,c),0==this.q.subtract(BigInteger.ONE).gcd(e).compareTo(BigInteger.ONE)&&this.q.isProbablePrime(10)););if(0>=this.p.compareTo(this.q)){var f=this.p;this.p=this.q;this.q=f}var f=this.p.subtract(BigInteger.ONE),
g=this.q.subtract(BigInteger.ONE),h=f.multiply(g);if(0==h.gcd(e).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q);this.d=e.modInverse(h);this.dmp1=this.d.mod(f);this.dmq1=this.d.mod(g);this.coeff=this.q.modInverse(this.p);break}}};RSAKey.prototype.doPrivate=function(a){if(null==this.p||null==this.q)return a.modPow(this.d,this.n);for(var d=a.mod(this.p).modPow(this.dmp1,this.p),a=a.mod(this.q).modPow(this.dmq1,this.q);0>d.compareTo(a);)d=d.add(this.p);return d.subtract(a).multiply(this.coeff).mod(this.p).multiply(this.q).add(a)};
RSAKey.prototype.decrypt=function(a){a=this.doPrivate(new BigInteger(a,16));return null==a?null:pkcs1unpad2(a,this.n.bitLength()+7>>3)};